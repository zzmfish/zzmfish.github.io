<html>
<head>
<title>笔记编辑</title>
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<script src="/js/slidebar.js"></script>
<script src="/lib/ace/ace.js"></script>
<script src="/lib/ace/mode-markdown.js" type="text/javascript" charset="utf-8"></script>
<script>
var gIsRendering = false;
var gFileName = null;
var gNeedRendering = false;

function debug(msg)
{
    console.log(msg);
}

function NeedSaveFile()
{
    return ! document.getElementById('SaveButton').hasAttribute('disabled')
            && editor.getValue();
}

function ConfirmUnsavedFile()
{
    if (NeedSaveFile() && confirm("是否保存文件？"))
        SaveFile();
}

function EditFile(fileName)
{
    debug('EditFile(' + fileName + ')');
    ConfirmUnsavedFile();

    //发起http请求：获取markdown文件内容
    var req = new XMLHttpRequest();
    req.open('GET', '/GetFile?f=' + encodeURIComponent(fileName), true);
    req.onreadystatechange = function() {
        if (req.readyState == 4 && req.status == 200) {
            //得到文件内容，并设置到编辑器
            editor.setValue(req.responseText, -1);
            editor.focus();
            document.getElementById('EditorContainer').style.display = '';
            document.getElementById('SaveButton').setAttribute('disabled', '');
            gFileName = fileName;
            location.hash = fileName
            gNeedRendering = true;
            Render();
        }
    }
    req.send();
}

function SaveFile()
{
    if (!gFileName)
        return;
    //发起http请求：保存文件
    var req_content = 'text=' + encodeURIComponent(editor.getValue())
            + '&f=' + encodeURIComponent(gFileName);
    var req = new XMLHttpRequest();
    req.open('POST', '/SaveFile', false);
    req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    req.setRequestHeader("Content-length", req_content.length);
    req.send(req_content);

    //显示保存成功或失败
    var statusElem = document.getElementById('Status');
    if (req.status == 200) {
        statusElem.textContent = '文件保存成功！';
        document.getElementById('SaveButton').setAttribute('disabled', '');
    }
    else
        statusElem.textContent = '文件保存失败！';

    //取消显示
    setTimeout(function() {
        statusElem.textContent = '';
    }, 3000);
}

function Render()
{
    if (!gNeedRendering) return;
    if (gIsRendering) return;
    gIsRendering = true;

    //发起http请求：把markdown渲染成html
    var req_content = 'text=' + encodeURIComponent(editor.getValue());
    var req = new XMLHttpRequest();
    req.open('POST', '/Render', true);
    req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    req.setRequestHeader("Content-length", req_content.length);
    req.setRequestHeader("Connection", "close");
    req.onreadystatechange = function() {
        if (req.readyState == 4) {
            if (req.status == 200) {
                //得到子文档对象
                var renderer = document.getElementById('Renderer');
                var wnd = renderer.contentWindow;
                var doc = wnd.document;

                //得到子文档滚动位置
                var docY = wnd.scrollY;
                var maxY = doc.height - wnd.innerHeight;
                console.log('Render: docY=' + docY + ', maxY=' + maxY);

                //在子文档显示渲染的html
                doc.open();
                doc.write(req.responseText);

                //定位到末尾
                renderer.onload = function() {
                    if (maxY > 0 && docY >= maxY) {
                        wnd.scrollTo(0, 9999);
                    }
                    else {
                        wnd.scrollTo(0, docY);
                    }
                }
                doc.close(); //触发onload
            }
            gIsRendering = false;
            gNeedRendering = false;
        }
    }
    req.send(req_content);
}

function OnContentChange()
{
    document.getElementById('SaveButton').removeAttribute('disabled');
    document.getElementById('Status').textContent = '';
    gNeedRendering = true;
    setTimeout(Render, 1500);
}
</script>
</head>
<body style="padding:0px;margin:0px;">

<div id="SlideBar" style="position:absolute; width:300px; top:0px; left: -300px; z-index:9999;">
    <ul>
        {% for f in files %}
        <li><a href="javascript:EditFile('{{ url_escape(f) }}')">{{ f }}</a></li>
        {% end %}
    </ul>
</div>

<table style="width:100%; height:100%;" id="EditorContainer" border="0" cellspacing="0">
    <tr>
        <td style="width:50%">
            <table border="0" cellspacing="0" style="width:100%; height:100%">
                <tr>
                    <td>
                        <div id="Editor" style="position:relative; width:100%; height:100%; font-size:14px;"></div>
                    </td>
                </tr>
                <tr>
                    <td style="height:20px;">
                        <div id="SlideTrigger" style="float:left;">菜单</div>
                        <span id="Status"></span>
                        <button id="SaveButton" onclick="SaveFile()" disabled style="float:right">保存</button>
                    </td>
                </tr>
            </table>
        </td>
        <td style="width:50%">
            <iframe id="Renderer" style="width:100%; height:100%; border:0px;" border=0></iframe>
        </td>
    </tr>
</table>

<script>
//初始化编辑器
var editor = ace.edit("Editor");
var MarkdownMode = require("ace/mode/markdown").Mode;
editor.renderer.setOption('showLineNumbers', false);
editor.renderer.setOption('showGutter', false);
editor.renderer.setOption('showPrintMargin', false);
editor.getSession().setMode(new MarkdownMode());
editor.getSession().setUseWrapMode(true);
editor.on("change", OnContentChange);

if (location.hash)
    EditFile(location.hash.substr(1));
InitSlideBar('SlideBar', 'SlideTrigger');

window.onbeforeunload = function() {
    if (NeedSaveFile())
        return "文档没保存，是否离开？"
}
</script>
</body>
</html>
