<html>
<head>
<script>
var gIsRendering = false;
var gFileName = null;

function EditFile(fileName)
{
    //发起http请求：获取markdown文件内容
    var req = new XMLHttpRequest();
    req.open('GET', '/GetFile?f=' + encodeURIComponent(fileName), true);
    req.onreadystatechange = function() {
        if (req.readyState == 4 && req.status == 200) {
            //得到文件内容，并设置到编辑器
            document.getElementById('Editor').value = req.responseText;
            document.getElementById('EditorContainer').style.display = '';
            document.getElementById('SaveButton').setAttribute('disabled', '');
            gFileName = fileName;
            Render();
        }
    }
    req.send();
}

function SaveFile()
{
    if (!gFileName)
        return;
    //发起http请求：保存文件
    var req_content = 'text=' + encodeURIComponent(document.getElementById('Editor').value)
            + '&f=' + encodeURIComponent(gFileName);
    var req = new XMLHttpRequest();
    req.open('POST', '/SaveFile', false);
    req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    req.setRequestHeader("Content-length", req_content.length);
    req.send(req_content);
    if (req.status == 200)
        document.getElementById('Status').textContent = '文件保存成功！';
    else
        document.getElementById('Status').textContent = '文件保存失败！';

}

function Render()
{
    if (gIsRendering) return;
    gIsRendering = true;

    //发起http请求：把markdown渲染成html
    var req_content = 'text=' + encodeURIComponent(document.getElementById('Editor').value);
    var req = new XMLHttpRequest();
    req.open('POST', '/Render', true);
    req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    req.setRequestHeader("Content-length", req_content.length);
    req.setRequestHeader("Connection", "close");
    req.onreadystatechange = function() {
        if (req.readyState == 4) {
            if (req.status == 200) {
                //得到渲染的html，并在iframe显示
                document.getElementById('Renderer').src = 'data:text/html;base64,' + req.responseText;
            }
            gIsRendering = false;
        }
    }
    req.send(req_content);
}

function OnContentChange()
{
    document.getElementById('SaveButton').removeAttribute('disabled');
    document.getElementById('Status').textContent = '';
    Render();
}
</script>
</head>
<body>
<table style="width:100%; height:100%">
<tr>
    <td valign="top" style="width:300px;">
        <ul style="list-style-type:none; padding:0px;">
            {% for f in files %}
            <li><a href="javascript:EditFile('{{ url_escape(f) }}')">{{ f }}</a></li>
            {% end %}
        </ul>
    </td>
    <td valign="top">
        <table style="width:100%; height:100%; display:none;" id="EditorContainer">
            <tr>
                <td style="width:50%">
                    <textarea id="Editor" style="width:100%; height:100%;" oninput="OnContentChange()"></textarea>
                </td>
                <td style="width:50%">
                    <iframe id="Renderer" style="width:100%; height:100%; border:0px;" border=0></iframe>
                </td>
            </tr>
            <tr style="height:20px;">
                <td style="text-align:right;">
                    <span id="Status"></span>
                    <button id="SaveButton" onclick="SaveFile()" disabled>保存</button>
                </td>
            </tr>
        </table>
    </td>
</tr>
</table>
</body>
</html>
